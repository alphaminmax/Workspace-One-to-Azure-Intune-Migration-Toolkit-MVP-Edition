<#
.SYNOPSIS
    Workspace ONE UEM Deployment Script
.DESCRIPTION
    Extracts Payload.zip, runs MasterScript.ps1, and logs output.
#>

# Configurable variables
$TempPath       = "$env:ProgramData\UEMDeploy"
$ZipFile        = "$PSScriptRoot\WS1MigrationTool.zip"
$ExtractedPath  = "$TempPath\WS1MigrationTool"
$LogFolder      = "$TempPath\Logs"
$LogFile        = "$LogFolder\Deploy_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
$MasterScript   = "startMigrate.ps1"  # Change this if your script has a different name
$RunCleanup     = $true               # Set to $false if you want to preserve extracted files

# Ensure logging directory exists
New-Item -ItemType Directory -Path $LogFolder -Force | Out-Null

Function Write-Log {
    param([string]$Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Add-Content -Path $LogFile -Value "$timestamp : $Message"
    Write-Host $Message
}

Function Extract-ZipFile {
    param (
        [string]$zipFile,
        [string]$destination
    )
    try {
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($zipFile, $destination)
        Write-Log "Successfully extracted $zipFile to $destination"
        return $true
    } catch {
        Write-Log "ERROR: Failed to extract ZIP: $_"
        return $false
    }
}

Function Run-MasterScript {
    param (
        [string]$scriptPath
    )
    try {
        if (Test-Path $scriptPath) {
            Write-Log "Running master script: $scriptPath"
            powershell.exe -ExecutionPolicy Bypass -File $scriptPath *>> $LogFile
            Write-Log "Master script execution completed."
            return $true
        } else {
            Write-Log "ERROR: Master script not found at: $scriptPath"
            return $false
        }
    } catch {
        Write-Log "ERROR: Exception while running master script: $_"
        return $false
    }
}

# Main Execution
Write-Log "===== Workspace ONE UEM Deploy Script Started ====="
Write-Log "Zip file: $ZipFile"
Write-Log "Temp extract path: $ExtractedPath"

# Create extraction folder
try {
    New-Item -ItemType Directory -Path $ExtractedPath -Force | Out-Null
} catch {
    Write-Log "ERROR: Failed to create temp folder: $_"
    exit 1
}

# Extract zip
if (-not (Extract-ZipFile -zipFile $ZipFile -destination $ExtractedPath)) {
    Write-Log "ERROR: Extraction failed. Exiting."
    exit 1
}

# Execute the master script
$scriptToRun = Join-Path $ExtractedPath $MasterScript
if (-not (Run-MasterScript -scriptPath $scriptToRun)) {
    Write-Log "ERROR: Master script execution failed."
    exit 1
}

# Optional Cleanup
if ($RunCleanup -and (Test-Path $ExtractedPath)) {
    try {
        Remove-Item -Path $ExtractedPath -Recurse -Force
        Write-Log "Cleanup successful: Removed extracted files."
    } catch {
        Write-Log "WARNING: Cleanup failed: $_"
    }
}

Write-Log "===== Deployment Completed Successfully ====="
exit 0